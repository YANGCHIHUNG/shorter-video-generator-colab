# 字幕長度控制功能說明

## 🎯 功能概述

本系統新增了智能字幕長度控制功能，可以自動將過長的字幕文字切分成適合顯示的片段，避免字幕超出畫面範圍，提升觀看體驗。

## 📏 長度控制模式

### 1. 🎛️ 緊湊模式 (Compact)
- **每行字元數**: 12字
- **最大行數**: 2行
- **總字元限制**: 24字
- **最小顯示時間**: 1.8秒
- **適用場景**: 手機或小螢幕觀看，需要更緊湊的顯示

### 2. 🎛️ 標準模式 (Standard) ⭐ **推薦**
- **每行字元數**: 15字
- **最大行數**: 2行
- **總字元限制**: 30字
- **最小顯示時間**: 1.5秒
- **適用場景**: 大多數情況，平衡可讀性與螢幕適配

### 3. 🎛️ 寬鬆模式 (Relaxed)
- **每行字元數**: 18字
- **最大行數**: 2行
- **總字元限制**: 36字
- **最小顯示時間**: 1.2秒
- **適用場景**: 大螢幕觀看，較少換行

### 4. 🎛️ 自動模式 (Auto)
- **智能選擇**: 根據內容長度自動選擇最佳切分方式
- **預設參數**: 與標準模式相同
- **適用場景**: 不確定最佳設置時的智能選擇

## 🔧 技術實現

### 智能切分策略

#### 1. **標點符號優先切分**
```python
def _smart_split_by_punctuation(self, text: str, max_chars: int):
    # 優先按句號、問號、感嘆號等切分
    punctuation_marks = ['。', '！', '？', '；', '，', '、', '：']
    # 保持語意完整性的同時控制長度
```

#### 2. **強制長度切分**
```python
def _force_split_long_sentence(self, sentence: str, start_time: float, end_time: float):
    # 對於超長句子進行強制切分
    # 按最大字元數限制分割
    # 維持時間比例分配
```

#### 3. **智能行格式化**
```python
def _format_subtitle_lines(self, text: str, max_chars_per_line: int):
    # 自動換行處理
    # 最多兩行顯示
    # 避免單字成行
```

### 時間分配算法

#### **比例時間分配**
- 根據文字長度比例分配時間
- 確保每個片段最小顯示時間
- 最後片段對齊原始結束時間

#### **時間連續性保證**
- 避免時間重疊或倒退
- 保持字幕顯示的流暢性
- 智能調整顯示時長

## 📊 切分效果示例

### 原始長字幕
```
這是一個非常長的句子，包含了大量的文字內容，用於測試字幕切分功能是否能夠正確地將過長的文字分割成適合顯示的片段，確保觀眾能夠清楚地閱讀字幕內容。
```

### 緊湊模式切分結果
```
片段1: 0.0s-1.8s
這是一個非常長的句子，包
含了大量的文字內容，

片段2: 1.8s-3.1s  
用於測試字幕切分功能是否
能夠正確地將過長的文字分

片段3: 3.1s-3.6s
割成適合顯示的片段

片段4: 3.6s-5.0s
，確保觀眾能夠清楚地閱讀
字幕內容。
```

### 標準模式切分結果
```
片段1: 0.0s-1.5s
這是一個非常長的句子，包含了大
量的文字內容，

片段2: 1.5s-2.9s
用於測試字幕切分功能是否能夠正
確地將過長的文字分割成適合顯示

片段3: 2.9s-3.0s
的片段

片段4: 3.0s-5.0s
，確保觀眾能夠清楚地閱讀字幕內
容。
```

## 🎨 前端控制介面

### 用戶選項
在影片生成頁面的字幕選項中：

```html
<select name="subtitle_length_mode">
    <option value="auto" selected>自動切分 - 智能控制字幕長度</option>
    <option value="compact">緊湊模式 - 每行12字，最多2行</option>
    <option value="standard">標準模式 - 每行15字，最多2行</option>
    <option value="relaxed">寬鬆模式 - 每行18字，最多2行</option>
</select>
```

### 說明文字
- **自動切分**：根據內容長度智能選擇最佳切分方式
- **緊湊模式**：適合手機或小螢幕觀看
- **標準模式**：適合大多數情況，平衡可讀性與螢幕適配
- **寬鬆模式**：適合大螢幕，較少換行

## 🔄 系統整合

### API 參數傳遞
```python
# app.py 中的參數提取
subtitle_length_mode = request_data.get('subtitle_length_mode', 'auto')

# API 函數調用
api_with_edited_script(
    ...
    subtitle_length_mode=subtitle_length_mode
)

# 字幕生成器實例化
hybrid_generator = ImprovedHybridSubtitleGenerator(
    model_size="small",
    traditional_chinese=traditional_chinese,
    subtitle_length_mode=subtitle_length_mode
)
```

### 配置參數自動載入
```python
def _configure_length_parameters(self):
    """根據字幕長度模式自動配置參數"""
    length_configs = {
        'compact': {'max_chars_per_line': 12, 'max_lines': 2, 'min_display_time': 1.8},
        'standard': {'max_chars_per_line': 15, 'max_lines': 2, 'min_display_time': 1.5},
        'relaxed': {'max_chars_per_line': 18, 'max_lines': 2, 'min_display_time': 1.2},
        'auto': {'max_chars_per_line': 15, 'max_lines': 2, 'min_display_time': 1.5}
    }
```

## ✅ 解決的問題

### 1. **字幕超出畫面**
- ❌ 問題：長字幕左右兩側超出螢幕範圍
- ✅ 解決：智能切分，確保字幕在畫面內顯示

### 2. **可讀性問題**
- ❌ 問題：單行過長難以閱讀
- ✅ 解決：自動換行，最多兩行顯示

### 3. **顯示時間不足**
- ❌ 問題：內容多但顯示時間短
- ✅ 解決：確保最小顯示時間，時間比例分配

### 4. **語意完整性**
- ❌ 問題：隨意切分破壞語意
- ✅ 解決：優先按標點符號切分，保持語意完整

## 🎯 使用建議

### 推薦設置
- **一般用途**: 選擇「標準模式」
- **手機觀看**: 選擇「緊湊模式」
- **大螢幕**: 選擇「寬鬆模式」
- **不確定**: 選擇「自動模式」

### 效果對比
- **緊湊模式**: 字幕更小更緊湊，適合小螢幕
- **標準模式**: 平衡顯示效果，適合大多數情況
- **寬鬆模式**: 字幕更寬鬆，適合大螢幕高解析度

## 🧪 測試驗證

系統包含完整的測試腳本 `test_subtitle_length_control.py`：
- 測試不同長度模式的切分效果
- 驗證時間分配算法
- 檢查行格式化功能
- 確保系統穩定性

---

**這個字幕長度控制功能完美解決了字幕超出畫面的問題，讓觀眾能夠舒適地觀看帶字幕的影片！** 🎉
